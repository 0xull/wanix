#!/bin/busybox sh
/bin/busybox --install -s /bin

mount -t proc none /proc
mount -t sysfs none /sys
mount -t devtmpfs none /dev

# get the "linux for wanix" kernel argument if using for wanix to
# mount the host9p filesystem v86 may be providing
# and use ttyS0 for console
wmode=$(cat /proc/cmdline | awk '/wmode=/{split($0,a," "); for(i in a) if(a[i]~/^wmode=/) {sub(/^wmode=/,"",a[i]); print a[i]; exit}}')
console="tty1"
startdir="/"
if [ "$wmode" = "debug9p" ]; then
    mkdir -p /mnt/host9p
    mount -t 9p -o trans=virtio host9p /mnt/host9p
fi
if [ "$wmode" = "wanix" ]; then
    mkdir -p /wanix
    mount -t 9p -o trans=virtio host9p /wanix
    console="ttyS0"
    startdir="/wanix"
fi

# let kernel messages finish
sleep 1 

# start shell on $console with job control
setsid /bin/busybox sh -c "cd ${startdir} && LD_PRELOAD=/lib/preload.so exec /bin/busybox sh </dev/${console} >/dev/${console} 2>&1"